<!-- https://github.com/gohugoio/hugo/issues/1778#issuecomment-313895910 -->
<!-- ignore empty links with + -->
{{ $headers := findRE "<h[1-6].*?>(.|\n])+?</h[1-6]>" .Content }}
<!-- at least one header to link to -->
{{ $has_headers := ge (len $headers) 1 }}
<!-- a post can explicitly disable Table of Contents with toc: false -->
{{ $show_toc := (eq $.Params.toc true) }}
{{ if and $has_headers $show_toc }}
<nav id="TableOfContents">
    <ul>
    {{ range $headers }}
    {{ $header := . }}
    {{ range first 1 (findRE "<h[2-6]" $header 1) }}
    {{ range findRE "[1-6]" . 1 }}
    {{ $next_heading := (int .) }}
    <!-- generate li array of the proper depth -->
    {{ range seq $next_heading }}
        {{end}}
        {{ $base := ($.Page.File.LogicalName) }}
        {{ $anchorId := (partial "slugify.html" $header | htmlUnescape | plainify | anchorize | urlize ) }}
        {{ $href := delimit (slice $base $anchorId) "#" | string }}
        <li>
            <a href="{{ relref $.Page $href }}">{{ $header | htmlUnescape | plainify }}</a>
        </li>
        <!-- close list -->
        {{ range seq $next_heading }}
    {{end}}
    {{end}}
    {{end}}
    {{ end }}
    </ul>
</nav>
{{ end }}