{{/*
  Renders the menu for a specific product
  Args: dict with "product", "version", and "context" keys
*/}}
{{- $product := .product -}}
{{- $version := .version -}}
{{- $context := .context -}}
{{- $showvisitedlinks := $context.Site.Params.showVisitedLinks -}}

{{/* Handle special case for altinn-studio */}}
{{- if eq $product "altinn-studio" -}}
  {{- $altinnStudioPage := $context.Site.GetPage "/altinn-studio" -}}
  {{- $altinnStudioPageEnglish := $context.Site.GetPage "/en/altinn-studio" -}}
  {{- if and (not $altinnStudioPage) $altinnStudioPageEnglish -}}
    {{- $altinnStudioPage = $altinnStudioPageEnglish -}}
  {{- end -}}

  {{- if $altinnStudioPage -}}
    {{/* Show version dropdown */}}
    <div id="version-dropdown-top" class="altinn-studio-version-dropdown">
      <div class="version-selector-wrapper">
        <label class="version-label" for="version-selector-button" id="version-selector-label">
          {{- if eq $context.Site.Language.Lang "nb" -}}
            Versjon:
          {{- else if eq $context.Site.Language.Lang "nn" -}}
            Versjon:
          {{- else -}}
            Version:
          {{- end -}}
        </label>
        <div class="dropdown" role="combobox">
          <button
            type="button"
            id="version-selector-button"
            class="nav-link dropdown-toggle version-switcher"
            aria-expanded="false"
            aria-haspopup="listbox"
            aria-labelledby="version-selector-label"
            aria-describedby="version-selector-help"
            data-toggle="dropdown">
            <span id="current-version-top">{{ if $version }}{{ $version }}{{ else }}{{ T "select_version" | default "Select Version" }}{{ end }}</span>
          </button>
          <div
            class="dropdown-menu version-dropdown"
            role="listbox"
            aria-labelledby="version-selector-label"
            id="version-dropdown-menu">
            {{- range $altinnStudioPage.Sections -}}
              {{- $folderName := path.Base .RelPermalink -}}
              <a
                class="dropdown-item version-option"
                href="{{ .RelPermalink }}"
                data-version="{{ $folderName }}"
                role="option"
                tabindex="-1"
                aria-selected="{{if eq $folderName $version}}true{{else}}false{{end}}">
                <span class="version-item">{{ $folderName }}</span>
              </a>
            {{- end -}}
          </div>
        </div>
        <div id="version-selector-help" class="sr-only">
          {{- if eq $context.Site.Language.Lang "nb" -}}
            Bruk piltastene for 책 navigere mellom versjoner og Enter for 책 velge
          {{- else if eq $context.Site.Language.Lang "nn" -}}
            Bruk piltastane for 책 navigere mellom versjonar og Enter for 책 velje
          {{- else -}}
            Use arrow keys to navigate between versions and Enter to select
          {{- end -}}
        </div>
      </div>
    </div>

    {{/* Render the specific version's content */}}
    {{- if $version -}}
      {{- range $altinnStudioPage.Sections -}}
        {{- $versionName := path.Base .RelPermalink -}}
        {{- if eq $versionName $version -}}
          <li class="dd-item parent version-root-item">
            <a href="{{ .RelPermalink }}">
              <span>{{safeHTML .Params.Pre}}{{ .LinkTitle }}{{safeHTML .Params.Post}}</span>
              <i class="fa fa-sort-down fa-lg category-icon"></i>
              {{- if $showvisitedlinks -}}
                <i style="color:grey" class="fa fa-circle-thin read-icon"></i>
              {{- end -}}
            </a>
            <ul class="version-content">
              {{- if .Sections -}}
                {{- range .Sections -}}
                  {{- if not .Params.hidden -}}
                    {{- template "section-tree-nav" dict "sect" . "currentnode" $context "showvisitedlinks" $showvisitedlinks -}}
                  {{- end -}}
                {{- end -}}
              {{- end -}}
            </ul>
          </li>
          {{- break -}}
        {{- end -}}
      {{- end -}}
    {{- else -}}
      {{/* No specific version - show main altinn-studio page */}}
      {{- template "section-tree-nav" dict "sect" $altinnStudioPage "currentnode" $context "showvisitedlinks" $showvisitedlinks -}}
    {{- end -}}
  {{- end -}}
{{- else -}}
  {{/* Handle regular products by searching through all sections */}}
  {{- range $context.Site.Home.Sections -}}
    {{- $sectionPath := strings.TrimPrefix "/" .RelPermalink -}}
    {{- $sectionPath = strings.TrimSuffix "/" $sectionPath -}}
    {{- $sectionParts := split $sectionPath "/" -}}

    {{/* Check if this section matches our product */}}
    {{- $isMatch := false -}}
    {{- if gt (len $sectionParts) 0 -}}
      {{- $sectionProduct := "" -}}
      {{- if and (gt (len $sectionParts) 1) (in (slice "en" "nb" "nn") (index $sectionParts 0)) -}}
        {{/* Language-prefixed path like "en/authorization" */}}
        {{- $sectionProduct = index $sectionParts 1 -}}
      {{- else -}}
        {{/* Non-language-prefixed path like "authorization" */}}
        {{- $sectionProduct = index $sectionParts 0 -}}
      {{- end -}}
      {{- if eq $sectionProduct $product -}}
        {{- $isMatch = true -}}
      {{- end -}}
    {{- end -}}

    {{- if $isMatch -}}
      {{- template "section-tree-nav" dict "sect" . "currentnode" $context "showvisitedlinks" $showvisitedlinks -}}
      {{- break -}}
    {{- end -}}
  {{- end -}}
{{- end -}}