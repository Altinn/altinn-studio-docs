<nav id="sidebar" class="{{if $.Site.Params.showVisitedLinks }}showVisitedLinks{{end}}">
{{- $currentNode := . -}}
{{- $showvisitedlinks := .Site.Params.showVisitedLinks -}}
  {{- /* Version dropdown for Altinn Studio - above everything */ -}}
  {{- $altinnStudioPage := .Site.GetPage "/altinn-studio" -}}
  {{- if $altinnStudioPage -}}
    <div id="version-dropdown-top" class="altinn-studio-version-dropdown" style="display: none;">
      <div class="version-selector-wrapper">
        <label class="version-label" for="version-selector-button" id="version-selector-label">
          {{- if eq .Site.Language.Lang "nb" -}}
            Versjon:
          {{- else if eq .Site.Language.Lang "nn" -}}
            Versjon:
          {{- else -}}
            Version:
          {{- end -}}
        </label>
        <div class="dropdown" role="combobox">
          <button
            type="button"
            id="version-selector-button"
            class="nav-link dropdown-toggle version-switcher"
            aria-expanded="false"
            aria-haspopup="listbox"
            aria-labelledby="version-selector-label"
            aria-describedby="version-selector-help"
            data-toggle="dropdown">
            <span id="current-version-top">{{ T "select_version" | default "Select Version" }}</span>
          </button>
          <div
            class="dropdown-menu version-dropdown"
            role="listbox"
            aria-labelledby="version-selector-label"
            id="version-dropdown-menu">
            {{- range $altinnStudioPage.Sections -}}
              <a
                class="dropdown-item version-option"
                href="{{ .RelPermalink }}"
                data-version="{{ .LinkTitle }}"
                role="option"
                tabindex="-1"
                aria-selected="false">
                <span class="version-item">{{ .LinkTitle }}</span>
              </a>
            {{- end -}}
          </div>
        </div>
        <div id="version-selector-help" class="sr-only">
          {{- if eq .Site.Language.Lang "nb" -}}
            Bruk piltastene for 책 navigere mellom versjoner og Enter for 책 velge
          {{- else if eq .Site.Language.Lang "nn" -}}
            Bruk piltastane for 책 navigere mellom versjonar og Enter for 책 velje
          {{- else -}}
            Use arrow keys to navigate between versions and Enter to select
          {{- end -}}
        </div>
      </div>
    </div>
  {{- end -}}

  <div class="highlightable">
    <ul id="docsmenu" class="topics">
      {{- if not .Site.Params.noHomeIcon -}}
        <li class="dd-item">
          <a href="{{"/" | relURL}}"><i class="fa fa-fw fa-home"></i></a>
        </li>
      {{- end -}}
      {{- if eq .Site.Params.ordersectionsby "title" -}}
        {{- range .Site.Home.Sections.ByTitle -}}
          {{- $sectionPath := strings.TrimPrefix "/" .RelPermalink -}}
          {{- $sectionPath = strings.TrimSuffix "/" $sectionPath -}}
          {{- if not (or (eq .LinkTitle "altinn-studio") (eq .Title "altinn-studio") (eq $sectionPath "altinn-studio")) -}}
            <div class="menu-section" data-section="{{ $sectionPath }}">
              {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
            </div>
          {{- end -}}
        {{- end -}}
      {{- else -}}
        {{- range .Site.Home.Sections.ByWeight -}}
          {{- $sectionPath := strings.TrimPrefix "/" .RelPermalink -}}
          {{- $sectionPath = strings.TrimSuffix "/" $sectionPath -}}
          {{- if not (or (eq .LinkTitle "altinn-studio") (eq .Title "altinn-studio") (eq $sectionPath "altinn-studio")) -}}
            <div class="menu-section" data-section="{{ $sectionPath }}">
              {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
            </div>
          {{- end -}}
        {{- end -}}
      {{- end -}}

      {{- /* Add main altinn-studio section with version handling */ -}}
      {{- $altinnStudioPage := .Site.GetPage "/altinn-studio" -}}
      {{- if $altinnStudioPage -}}
        {{- $altinnStudioPath := strings.TrimPrefix "/" $altinnStudioPage.RelPermalink -}}
        {{- $altinnStudioPath = strings.TrimSuffix "/" $altinnStudioPath -}}
        <div class="menu-section" data-section="{{ $altinnStudioPath }}" data-version-container="true">
          <!-- Version-specific content sections -->
          {{- range $altinnStudioPage.Sections -}}
            {{- $versionPath := strings.TrimPrefix "/" .RelPermalink -}}
            {{- $versionPath = strings.TrimSuffix "/" $versionPath -}}
            <div class="version-section" data-version-section="{{ $versionPath }}" style="display: none;">
              {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
            </div>
          {{- end -}}
        </div>
      {{- end -}}

      <style>
        .menu-section {
          display: none;
        }
        .menu-section.active {
          display: block;
        }

        /* Version dropdown styling */
        .altinn-studio-version-dropdown {
          background: #f8f9fa;
          padding: 10px;
          border-bottom: 1px solid #ddd !important;
          margin-bottom: 0;
        }
        #sidebar .altinn-studio-version-dropdown {
          border-bottom: 1px solid #ddd !important;
        }
        .version-selector-wrapper {
          display: flex;
          flex-direction: column;
          gap: 6px;
        }
        .version-label {
          font-size: 12px;
          font-weight: 600;
          color: #555;
          margin: 0;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        .version-switcher {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 8px 12px;
          color: #333 !important;
          text-decoration: none !important;
          border: 1px solid #ccc;
          border-radius: 4px;
          background: white;
          width: 100%;
          box-sizing: border-box;
          cursor: pointer;
          font-family: inherit;
          font-size: inherit;
          text-align: left;
        }
        .version-switcher::after {
          margin-left: auto;
        }
        #sidebar .version-switcher {
          border-bottom: 1px solid #ccc !important;
        }
        .version-switcher:hover,
        .version-switcher:focus {
          background: #e9ecef;
          outline: none;
          border-color: #007bff;
        }
        .version-switcher:focus {
          box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        .version-option:focus,
        .version-option:hover {
          background: #007bff !important;
          color: white !important;
          outline: none;
        }
        .version-option[aria-selected="true"] {
          background: #28a745 !important;
          color: white !important;
        }
        .sr-only {
          position: absolute !important;
          width: 1px !important;
          height: 1px !important;
          padding: 0 !important;
          margin: -1px !important;
          overflow: hidden !important;
          clip: rect(0, 0, 0, 0) !important;
          white-space: nowrap !important;
          border: 0 !important;
        }
        .version-dropdown {
          min-width: 200px;
        }
        .version-item {
          margin: 0;
          padding: 4px 0;
        }
        .version-section {
          padding-top: 10px;
        }
      </style>

      <script>
        (function() {
          var currentPath = window.location.pathname;
          var rootPath = '';

          // Extract path parts from current URL
          var pathParts = currentPath.split('/').filter(function(part) { return part.length > 0; });

          if (pathParts.length > 0) {
            // Check if first part is a language code (nb, en, etc.)
            var languageCodes = ['nb', 'en', 'nn']; // Add more language codes as needed
            var firstPart = pathParts[0];

            if (languageCodes.indexOf(firstPart) !== -1 && pathParts.length > 1) {
              // If first part is language code, use second part as root path
              rootPath = pathParts[1];

              // Special handling for altinn-studio versions
              if (rootPath === 'altinn-studio' && pathParts.length > 2) {
                var versionPart = pathParts[2];
                if (versionPart.match(/^v\d+$/)) { // matches v8, v9, etc.
                  rootPath = 'altinn-studio/' + versionPart;
                }
              }
            } else {
              // Otherwise use first part as root path
              rootPath = firstPart;

              // Special handling for altinn-studio versions
              if (rootPath === 'altinn-studio' && pathParts.length > 1) {
                var versionPart = pathParts[1];
                if (versionPart.match(/^v\d+$/)) { // matches v8, v9, etc.
                  rootPath = 'altinn-studio/' + versionPart;
                }
              }
            }
          }

          // Find all menu sections
          var menuSections = document.querySelectorAll('.menu-section');

          // Show only the matching section
          for (var i = 0; i < menuSections.length; i++) {
            var section = menuSections[i];
            var sectionName = section.getAttribute('data-section');

            // Extract the product part from section name (e.g., "nb/authorization" -> "authorization")
            var sectionParts = sectionName.split('/');
            var sectionProduct = sectionParts.length > 1 ? sectionParts[sectionParts.length - 1] : sectionName;

            // Check for exact section match
            var shouldShow = false;

            if (!rootPath) {
              shouldShow = true; // Show all if no root path
            } else if (rootPath.indexOf('/') > -1) {
              // Handle version-specific paths like "altinn-studio/v8"
              var rootProduct = rootPath.split('/')[0]; // Extract "altinn-studio" from "altinn-studio/v8"

              // For altinn-studio version paths, only show the main altinn-studio section (not the version-specific ones)
              if (rootProduct === 'altinn-studio') {
                shouldShow = (sectionProduct === rootProduct && !sectionName.match(/\/v\d+$/));
              } else {
                // For other products with version paths, show exact matches
                shouldShow = sectionName === rootPath || sectionName.endsWith('/' + rootPath);
              }
            } else {
              // Standard product matching - be more specific to avoid duplicates
              if (rootPath === 'altinn-studio') {
                // For altinn-studio without version, only show the version container section
                shouldShow = (sectionName === 'altinn-studio' && section.getAttribute('data-version-container') === 'true');
              } else {
                shouldShow = sectionProduct === rootPath || sectionName === rootPath;
              }
            }


            if (shouldShow) {
              section.classList.add('active');
              section.style.display = 'block';
              section.style.visibility = 'visible';

              // Handle version-specific logic for Altinn Studio
              if (section.getAttribute('data-version-container') === 'true') {
                showVersionDropdown();
                handleVersionSwitching(section, currentPath);
              }
            } else {
              section.classList.remove('active');
              section.style.display = 'none';
            }
          }

          // Show/hide top version dropdown - show for both main altinn-studio and version-specific pages
          var shouldShowVersionDropdown = false;

          // Check if we're on any altinn-studio related page
          if (rootPath === 'altinn-studio' || (rootPath && rootPath.indexOf('altinn-studio') === 0)) {
            shouldShowVersionDropdown = true;
          }

          var topDropdown = document.getElementById('version-dropdown-top');
          if (topDropdown) {
            topDropdown.style.display = shouldShowVersionDropdown ? 'block' : 'none';

            // If we're showing the dropdown, update the current version display
            if (shouldShowVersionDropdown) {
              updateVersionDropdownDisplay(currentPath);
            }
          }

          function updateVersionDropdownDisplay(currentPath) {
            // Extract current version from path
            var pathParts = currentPath.split('/').filter(function(part) { return part.length > 0; });
            var currentVersion = null;

            // Find version in path (like v8, v9)
            for (var i = 0; i < pathParts.length; i++) {
              if (pathParts[i].match(/^v\d+$/)) {
                currentVersion = pathParts[i];
                break;
              }
            }

            // Update version dropdown display in top dropdown
            var versionSpan = document.getElementById('current-version-top');
            if (versionSpan) {
              if (currentVersion) {
                versionSpan.textContent = currentVersion;
              } else {
                versionSpan.textContent = 'Select Version';
              }
            }
          }

          function showVersionDropdown() {
            var topDropdown = document.getElementById('version-dropdown-top');
            if (topDropdown) {
              topDropdown.style.display = 'block';
            }
          }

          function handleVersionSwitching(container, currentPath) {
            // Extract current version from path
            var pathParts = currentPath.split('/').filter(function(part) { return part.length > 0; });
            var currentVersion = null;

            // Find version in path (like v8, v9)
            for (var i = 0; i < pathParts.length; i++) {
              if (pathParts[i].match(/^v\d+$/)) {
                currentVersion = pathParts[i];
                break;
              }
            }

            // Show the appropriate version section
            var versionSections = container.querySelectorAll('.version-section');
            for (var i = 0; i < versionSections.length; i++) {
              var versionSection = versionSections[i];
              var sectionPath = versionSection.getAttribute('data-version-section');

              if (currentVersion && sectionPath && sectionPath.indexOf(currentVersion) !== -1) {
                versionSection.style.display = 'block';
              } else {
                versionSection.style.display = 'none';
              }
            }
          }

          // Add keyboard navigation for version selector
          setupVersionSelectorAccessibility();

          function setupVersionSelectorAccessibility() {
            var button = document.getElementById('version-selector-button');
            var dropdown = document.getElementById('version-dropdown-menu');

            if (!button || !dropdown) return;

            var options = dropdown.querySelectorAll('.version-option');
            var currentFocusIndex = -1;

            button.addEventListener('keydown', function(e) {
              if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') {
                e.preventDefault();
                if (dropdown.style.display === 'none' || !dropdown.classList.contains('show')) {
                  showDropdown();
                  focusOption(0);
                }
              } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                showDropdown();
                focusOption(options.length - 1);
              }
            });

            dropdown.addEventListener('keydown', function(e) {
              if (e.key === 'ArrowDown') {
                e.preventDefault();
                focusOption(currentFocusIndex + 1);
              } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                focusOption(currentFocusIndex - 1);
              } else if (e.key === 'Enter') {
                e.preventDefault();
                if (currentFocusIndex >= 0 && options[currentFocusIndex]) {
                  window.location.href = options[currentFocusIndex].href;
                }
              } else if (e.key === 'Escape') {
                e.preventDefault();
                hideDropdown();
                button.focus();
              }
            });

            function showDropdown() {
              button.setAttribute('aria-expanded', 'true');
              dropdown.classList.add('show');
              dropdown.style.display = 'block';
            }

            function hideDropdown() {
              button.setAttribute('aria-expanded', 'false');
              dropdown.classList.remove('show');
              dropdown.style.display = 'none';
              currentFocusIndex = -1;
              updateAriaSelected();
            }

            function focusOption(index) {
              if (index < 0) index = options.length - 1;
              if (index >= options.length) index = 0;

              currentFocusIndex = index;
              options[currentFocusIndex].focus();
              updateAriaSelected();
            }

            function updateAriaSelected() {
              options.forEach(function(option, index) {
                option.setAttribute('aria-selected', index === currentFocusIndex ? 'true' : 'false');
              });
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
              if (!button.contains(e.target) && !dropdown.contains(e.target)) {
                hideDropdown();
              }
            });
          }
        })();
      </script>
      {{- with .Site.Menus.shortcuts -}}
        {{- range sort . "Weight" -}}
          <li>
              {{- .Pre -}}
              <a href="{{.RelPermalink}}">{{- safeHTML .Name -}}</a>
              {{- .Post -}}
          </li>
        {{- end -}}
        {{- if $.Site.Params.showVisitedLinks -}}
          <a class="" href="#" data-clear-history-toggle=""><i class="fa  fa-history"></i> {{T "Clear-History"}}</a>
        {{- end -}}
      {{- end -}}
    </ul>
  </div>
</nav>

<!-- templates -->
{{- define "section-tree-nav" -}}
  {{- $showvisitedlinks := .showvisitedlinks -}}
  {{- $currentNode := .currentnode -}}
  {{- $currentFileUniqueID := "" -}}
  {{- with $currentNode.File }}{{ $currentFileUniqueID = .UniqueID }}{{ end -}}
  {{- with .sect -}}
    {{- if .IsSection -}}
      {{ safeHTML .Params.head }}
      <li class="dd-item{{if .Params.alwaysopen}} parent{{end}}">
        <a href="{{ .RelPermalink}}"><span>{{safeHTML .Params.Pre}}{{.LinkTitle}}{{safeHTML .Params.Post}}</span>
          {{- if .Params.titleSup -}}
            <sup>{{.Params.titleSup}}</sup>
          {{- end -}}
          {{- $numberOfPages := (add (len .Pages) (len .Sections)) -}}
          {{- if ne $numberOfPages 0 -}}
            {{- if or (.IsAncestor $currentNode) (.Params.alwaysopen) -}}
              <i class="fa fa-sort-down fa-lg category-icon"></i>
            {{- else -}}
              <i class="fa fa-caret-right fa-lg category-icon"></i>
            {{- end -}}
          {{- end -}}
          {{- if $showvisitedlinks -}}
            <i style="color:grey" class="fa fa-circle-thin read-icon"></i>
          {{- end -}}
        </a>
        {{- if ne $numberOfPages 0 -}}
          <ul>
            {{- $currentNode.Scratch.Set "pages" .Pages -}}
            {{- if .Sections -}}
              {{- $currentNode.Scratch.Set "pages" (.Pages | union .Sections) -}}
            {{- end -}}
            {{ $pages := ($currentNode.Scratch.Get "pages") }}
          {{- if eq .Site.Params.ordersectionsby "title" -}}
            {{- range $pages.ByTitle -}}
              {{- if and .Params.hidden (not $.showhidden) -}}
              {{- else -}}
                {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
              {{- end -}}
            {{ end }}
          {{- else -}}
            {{- range $pages.ByWeight -}}
              {{- if and .Params.hidden (not $.showhidden) -}}
              {{- else -}}
                {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}
          </ul>
        {{- end -}}
      </li>
    {{- else -}}
      {{- if not .Params.Hidden -}}
        <li class="dd-item">
          <a href="{{ .RelPermalink}}">
            <span>{{safeHTML .Params.Pre}}{{.LinkTitle}}{{safeHTML .Params.Post}}</span>
          {{- if $showvisitedlinks -}}
            <i style="color:grey" class="fa fa-circle-thin read-icon"></i>
          {{- end -}}
          </a></li>
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

