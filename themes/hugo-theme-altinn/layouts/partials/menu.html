<nav id="sidebar" class="{{if $.Site.Params.showVisitedLinks }}showVisitedLinks{{end}}">
{{- $currentNode := . -}}
{{- $showvisitedlinks := .Site.Params.showVisitedLinks -}}
  <div class="highlightable">
    <ul id="docsmenu" class="topics">
      {{- if not .Site.Params.noHomeIcon -}}
        <li class="dd-item">
          <a href="{{"/" | relURL}}"><i class="fa fa-fw fa-home"></i></a>
        </li>
      {{- end -}}
      {{- if eq .Site.Params.ordersectionsby "title" -}}
        {{- range .Site.Home.Sections.ByTitle -}}
          {{- $sectionPath := strings.TrimPrefix "/" .RelPermalink -}}
          {{- $sectionPath = strings.TrimSuffix "/" $sectionPath -}}
          <div class="menu-section" data-section="{{ $sectionPath }}">
            {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
          </div>
        {{- end -}}
      {{- else -}}
        {{- range .Site.Home.Sections.ByWeight -}}
          {{- $sectionPath := strings.TrimPrefix "/" .RelPermalink -}}
          {{- $sectionPath = strings.TrimSuffix "/" $sectionPath -}}
          <div class="menu-section" data-section="{{ $sectionPath }}">
            {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
          </div>
        {{- end -}}
      {{- end -}}

      {{- /* Add version-specific sections for altinn-studio */ -}}
      {{- $v8Page := .Site.GetPage "/altinn-studio/v8" -}}
      {{- if $v8Page -}}
        {{- $versionPath := strings.TrimPrefix "/" $v8Page.RelPermalink -}}
        {{- $versionPath = strings.TrimSuffix "/" $versionPath -}}
        <div class="menu-section" data-section="{{ $versionPath }}">
          {{- template "section-tree-nav" dict "sect" $v8Page "currentnode" $v8Page "showvisitedlinks" $showvisitedlinks -}}
        </div>
      {{- end -}}
      {{- $v9Page := .Site.GetPage "/altinn-studio/v9" -}}
      {{- if $v9Page -}}
        {{- $versionPath := strings.TrimPrefix "/" $v9Page.RelPermalink -}}
        {{- $versionPath = strings.TrimSuffix "/" $versionPath -}}
        <div class="menu-section" data-section="{{ $versionPath }}">
          {{- template "section-tree-nav" dict "sect" $v9Page "currentnode" $v9Page "showvisitedlinks" $showvisitedlinks -}}
        </div>
      {{- end -}}

      <style>
        .menu-section {
          display: none;
        }
        .menu-section.active {
          display: block;
        }
      </style>

      <script>
        (function() {
          var currentPath = window.location.pathname;
          var rootPath = '';

          // Extract path parts from current URL
          var pathParts = currentPath.split('/').filter(function(part) { return part.length > 0; });

          if (pathParts.length > 0) {
            // Check if first part is a language code (nb, en, etc.)
            var languageCodes = ['nb', 'en', 'nn']; // Add more language codes as needed
            var firstPart = pathParts[0];

            if (languageCodes.indexOf(firstPart) !== -1 && pathParts.length > 1) {
              // If first part is language code, use second part as root path
              rootPath = pathParts[1];

              // Special handling for altinn-studio versions
              if (rootPath === 'altinn-studio' && pathParts.length > 2) {
                var versionPart = pathParts[2];
                if (versionPart.match(/^v\d+$/)) { // matches v8, v9, etc.
                  rootPath = 'altinn-studio/' + versionPart;
                }
              }
            } else {
              // Otherwise use first part as root path
              rootPath = firstPart;

              // Special handling for altinn-studio versions
              if (rootPath === 'altinn-studio' && pathParts.length > 1) {
                var versionPart = pathParts[1];
                if (versionPart.match(/^v\d+$/)) { // matches v8, v9, etc.
                  rootPath = 'altinn-studio/' + versionPart;
                }
              }
            }
          }

          // Find all menu sections
          var menuSections = document.querySelectorAll('.menu-section');

          // Show only the matching section
          for (var i = 0; i < menuSections.length; i++) {
            var section = menuSections[i];
            var sectionName = section.getAttribute('data-section');

            // Extract the product part from section name (e.g., "nb/authorization" -> "authorization")
            var sectionParts = sectionName.split('/');
            var sectionProduct = sectionParts.length > 1 ? sectionParts[sectionParts.length - 1] : sectionName;

            // Check for exact section match
            var shouldShow = false;

            if (!rootPath) {
              shouldShow = true; // Show all if no root path
            } else if (rootPath.indexOf('/') > -1) {
              // Handle version-specific paths like "altinn-studio/v8"
              // Look for exact match first, then fallback to product match
              shouldShow = sectionName === rootPath ||
                          sectionName.endsWith('/' + rootPath);
            } else {
              // Standard product matching
              shouldShow = sectionProduct === rootPath || sectionName.indexOf(rootPath) !== -1;
            }

            if (shouldShow) {
              section.classList.add('active');
              section.style.display = 'block';
              section.style.visibility = 'visible';
            } else {
              section.classList.remove('active');
              section.style.display = 'none';
            }
          }
        })();
      </script>
      {{- with .Site.Menus.shortcuts -}}
        {{- range sort . "Weight" -}}
          <li>
              {{- .Pre -}}
              <a href="{{.RelPermalink}}">{{- safeHTML .Name -}}</a>
              {{- .Post -}}
          </li>
        {{- end -}}
        {{- if $.Site.Params.showVisitedLinks -}}
          <a class="" href="#" data-clear-history-toggle=""><i class="fa  fa-history"></i> {{T "Clear-History"}}</a>
        {{- end -}}
      {{- end -}}
    </ul>
  </div>
</nav>

<!-- templates -->
{{- define "section-tree-nav" -}}
  {{- $showvisitedlinks := .showvisitedlinks -}}
  {{- $currentNode := .currentnode -}}
  {{- $currentFileUniqueID := "" -}}
  {{- with $currentNode.File }}{{ $currentFileUniqueID = .UniqueID }}{{ end -}}
  {{- with .sect -}}
    {{- if .IsSection -}}
      {{ safeHTML .Params.head }}
      <li class="dd-item{{if .Params.alwaysopen}} parent{{end}}">
        <a href="{{ .RelPermalink}}"><span>{{safeHTML .Params.Pre}}{{.LinkTitle}}{{safeHTML .Params.Post}}</span>
          {{- if .Params.titleSup -}}
            <sup>{{.Params.titleSup}}</sup>
          {{- end -}}
          {{- $numberOfPages := (add (len .Pages) (len .Sections)) -}}
          {{- if ne $numberOfPages 0 -}}
            {{- if or (.IsAncestor $currentNode) (.Params.alwaysopen) -}}
              <i class="fa fa-sort-down fa-lg category-icon"></i>
            {{- else -}}
              <i class="fa fa-caret-right fa-lg category-icon"></i>
            {{- end -}}
          {{- end -}}
          {{- if $showvisitedlinks -}}
            <i style="color:grey" class="fa fa-circle-thin read-icon"></i>
          {{- end -}}
        </a>
        {{- if ne $numberOfPages 0 -}}
          <ul>
            {{- $currentNode.Scratch.Set "pages" .Pages -}}
            {{- if .Sections -}}
              {{- $currentNode.Scratch.Set "pages" (.Pages | union .Sections) -}}
            {{- end -}}
            {{ $pages := ($currentNode.Scratch.Get "pages") }}
          {{- if eq .Site.Params.ordersectionsby "title" -}}
            {{- range $pages.ByTitle -}}
              {{- if and .Params.hidden (not $.showhidden) -}}
              {{- else -}}
                {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
              {{- end -}}
            {{ end }}
          {{- else -}}
            {{- range $pages.ByWeight -}}
              {{- if and .Params.hidden (not $.showhidden) -}}
              {{- else -}}
                {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}
          </ul>
        {{- end -}}
      </li>
    {{- else -}}
      {{- if not .Params.Hidden -}}
        <li class="dd-item">
          <a href="{{ .RelPermalink}}">
            <span>{{safeHTML .Params.Pre}}{{.LinkTitle}}{{safeHTML .Params.Post}}</span>
          {{- if $showvisitedlinks -}}
            <i style="color:grey" class="fa fa-circle-thin read-icon"></i>
          {{- end -}}
          </a></li>
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

