<nav id="sidebar" class="{{if $.Site.Params.showVisitedLinks }}showVisitedLinks{{end}}">
{{- $currentNode := . -}}
{{- $showvisitedlinks := .Site.Params.showVisitedLinks -}}

{{/* Get current product using our detection logic */}}
{{- $productInfo := partial "get-current-product.html" . -}}
{{- $currentProduct := $productInfo.product -}}
{{- $currentVersion := $productInfo.version -}}

{{/* Version dropdown for Altinn Studio */}}
{{- $altinnStudioPage := .Site.GetPage "/altinn-studio" -}}
{{- if not $altinnStudioPage -}}
  {{- $altinnStudioPage = .Site.GetPage "/en/altinn-studio" -}}
{{- end -}}

{{- if and $altinnStudioPage (or (eq $currentProduct "altinn-studio") (not $currentProduct)) -}}
  <div id="version-dropdown-top" class="altinn-studio-version-dropdown"{{if ne $currentProduct "altinn-studio"}} style="display: none;"{{end}}>
    <div class="version-selector-wrapper">
      <label class="version-label" for="version-selector-button" id="version-selector-label">
        {{- if eq .Site.Language.Lang "nb" -}}
          Versjon:
        {{- else if eq .Site.Language.Lang "nn" -}}
          Versjon:
        {{- else -}}
          Version:
        {{- end -}}
      </label>
      <div class="dropdown" role="combobox">
        <button
          type="button"
          id="version-selector-button"
          class="nav-link dropdown-toggle version-switcher"
          aria-expanded="false"
          aria-haspopup="listbox"
          aria-labelledby="version-selector-label"
          aria-describedby="version-selector-help"
          data-toggle="dropdown">
          <span id="current-version-top">{{ if $currentVersion }}{{ $currentVersion }}{{ else }}{{ T "select_version" | default "Select Version" }}{{ end }}</span>
        </button>
        <div
          class="dropdown-menu version-dropdown"
          role="listbox"
          aria-labelledby="version-selector-label"
          id="version-dropdown-menu">
          {{- range $altinnStudioPage.Sections -}}
            {{- $folderName := path.Base .RelPermalink -}}
            <a
              class="dropdown-item version-option"
              href="{{ .RelPermalink }}"
              data-version="{{ $folderName }}"
              role="option"
              tabindex="-1"
              aria-selected="{{if eq $folderName $currentVersion}}true{{else}}false{{end}}">
              <span class="version-item">{{ $folderName }}</span>
            </a>
          {{- end -}}
        </div>
      </div>
      <div id="version-selector-help" class="sr-only">
        {{- if eq .Site.Language.Lang "nb" -}}
          Bruk piltastene for 책 navigere mellom versjoner og Enter for 책 velge
        {{- else if eq .Site.Language.Lang "nn" -}}
          Bruk piltastane for 책 navigere mellom versjonar og Enter for 책 velje
        {{- else -}}
          Use arrow keys to navigate between versions and Enter to select
        {{- end -}}
      </div>
    </div>
  </div>
{{- end -}}

<div class="highlightable">
  <ul id="docsmenu" class="topics">
    {{- if not .Site.Params.noHomeIcon -}}
      <li class="dd-item">
        <a href="{{"/" | relURL}}"><i class="fa fa-fw fa-home"></i></a>
      </li>
    {{- end -}}

    {{/* Only render the current product's menu server-side */}}
    {{- if $currentProduct -}}
      {{- if eq $currentProduct "altinn-studio" -}}
        {{/* Handle Altinn Studio with version logic */}}
        {{- if and $altinnStudioPage $currentVersion -}}
          {{- range $altinnStudioPage.Sections -}}
            {{- $versionName := path.Base .RelPermalink -}}
            {{- if eq $versionName $currentVersion -}}
              <li class="dd-item parent version-root-item">
                <a href="{{ .RelPermalink }}">
                  <span>{{safeHTML .Params.Pre}}{{ .LinkTitle }}{{safeHTML .Params.Post}}</span>
                  <i class="fa fa-sort-down fa-lg category-icon"></i>
                  {{- if $showvisitedlinks -}}
                    <i style="color:grey" class="fa fa-circle-thin read-icon"></i>
                  {{- end -}}
                </a>
                <ul class="version-content">
                  {{- if .Sections -}}
                    {{- range .Sections -}}
                      {{- if not .Params.hidden -}}
                        {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
                      {{- end -}}
                    {{- end -}}
                  {{- end -}}
                </ul>
              </li>
            {{- end -}}
          {{- end -}}
        {{- else -}}
          {{/* No version specified - show main altinn-studio */}}
          {{- template "section-tree-nav" dict "sect" $altinnStudioPage "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
        {{- end -}}
      {{- else -}}
        {{/* Handle regular products */}}
        {{- range .Site.Home.Sections -}}
          {{- $sectionPath := strings.TrimPrefix "/" .RelPermalink -}}
          {{- $sectionPath = strings.TrimSuffix "/" $sectionPath -}}
          {{- $sectionParts := split $sectionPath "/" -}}

          {{- $sectionProduct := "" -}}
          {{- if gt (len $sectionParts) 0 -}}
            {{- if and (gt (len $sectionParts) 1) (in (slice "en" "nb" "nn") (index $sectionParts 0)) -}}
              {{- $sectionProduct = index $sectionParts 1 -}}
            {{- else -}}
              {{- $sectionProduct = index $sectionParts 0 -}}
            {{- end -}}
          {{- end -}}

          {{- if eq $sectionProduct $currentProduct -}}
            {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
            {{- break -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- else -}}
      {{/* Home page - render all products overview */}}
      {{- partial "render-home-menu.html" . -}}
    {{- end -}}

    {{- with .Site.Menus.shortcuts -}}
      {{- range sort . "Weight" -}}
        <li>
            {{- .Pre -}}
            <a href="{{.RelPermalink}}">{{- safeHTML .Name -}}</a>
            {{- .Post -}}
        </li>
      {{- end -}}
      {{- if $.Site.Params.showVisitedLinks -}}
        <a class="" href="#" data-clear-history-toggle=""><i class="fa  fa-history"></i> {{T "Clear-History"}}</a>
      {{- end -}}
    {{- end -}}
  </ul>
</div>

<style>
  /* Version dropdown styling */
  .altinn-studio-version-dropdown {
    background: #f8f9fa;
    padding: 10px;
    border-bottom: 1px solid #ddd !important;
    margin-bottom: 0;
  }
  #sidebar .altinn-studio-version-dropdown {
    border-bottom: 1px solid #ddd !important;
  }
  .version-selector-wrapper {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .version-label {
    font-size: 12px;
    font-weight: 600;
    color: #555;
    margin: 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .version-switcher {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    color: #333 !important;
    text-decoration: none !important;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: white;
    width: 100%;
    box-sizing: border-box;
    cursor: pointer;
    font-family: inherit;
    font-size: inherit;
    text-align: left;
  }
  .version-switcher::after {
    margin-left: auto;
  }
  #sidebar .version-switcher {
    border-bottom: 1px solid #ccc !important;
  }
  .version-switcher:hover,
  .version-switcher:focus {
    background: #e9ecef;
    outline: none;
    border-color: #007bff;
  }
  .version-switcher:focus {
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
  }
  .version-option:focus,
  .version-option:hover {
    background: #007bff !important;
    color: white !important;
    outline: none;
  }
  .version-option[aria-selected="true"] {
    background: #28a745 !important;
    color: white !important;
  }
  .sr-only {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
  }
  .version-dropdown {
    min-width: 200px;
  }
  .version-item {
    margin: 0;
    padding: 4px 0;
  }
  .version-section {
    padding-top: 10px;
  }

  /* Ensure version root menu items are always visible */
  .version-root-item {
    display: block !important;
  }

  /* Prevent duplicate menu items */
  .version-content .version-section > li {
    list-style: none;
  }
</style>

<script>
  (function() {
    // Simplified JavaScript - only for dropdown functionality
    setupVersionSelectorAccessibility();

    function setupVersionSelectorAccessibility() {
      var button = document.getElementById('version-selector-button');
      var dropdown = document.getElementById('version-dropdown-menu');

      if (!button || !dropdown) return;

      var options = dropdown.querySelectorAll('.version-option');
      var currentFocusIndex = -1;

      button.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown') {
          e.preventDefault();
          if (dropdown.style.display === 'none' || !dropdown.classList.contains('show')) {
            showDropdown();
            focusOption(0);
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          showDropdown();
          focusOption(options.length - 1);
        }
      });

      dropdown.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          focusOption(currentFocusIndex + 1);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          focusOption(currentFocusIndex - 1);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (currentFocusIndex >= 0 && options[currentFocusIndex]) {
            window.location.href = options[currentFocusIndex].href;
          }
        } else if (e.key === 'Escape') {
          e.preventDefault();
          hideDropdown();
          button.focus();
        }
      });

      button.addEventListener('click', function(e) {
        e.preventDefault();
        if (dropdown.style.display === 'none' || !dropdown.classList.contains('show')) {
          showDropdown();
        } else {
          hideDropdown();
        }
      });

      function showDropdown() {
        button.setAttribute('aria-expanded', 'true');
        dropdown.classList.add('show');
        dropdown.style.display = 'block';
      }

      function hideDropdown() {
        button.setAttribute('aria-expanded', 'false');
        dropdown.classList.remove('show');
        dropdown.style.display = 'none';
        currentFocusIndex = -1;
        updateAriaSelected();
      }

      function focusOption(index) {
        if (index < 0) index = options.length - 1;
        if (index >= options.length) index = 0;

        currentFocusIndex = index;
        options[currentFocusIndex].focus();
        updateAriaSelected();
      }

      function updateAriaSelected() {
        options.forEach(function(option, index) {
          option.setAttribute('aria-selected', index === currentFocusIndex ? 'true' : 'false');
        });
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', function(e) {
        if (!button.contains(e.target) && !dropdown.contains(e.target)) {
          hideDropdown();
        }
      });
    }
  })();
</script>
</nav>

<!-- templates -->
{{- define "section-tree-nav" -}}
  {{- $showvisitedlinks := .showvisitedlinks -}}
  {{- $currentNode := .currentnode -}}
  {{- $currentFileUniqueID := "" -}}
  {{- with $currentNode.File }}{{ $currentFileUniqueID = .UniqueID }}{{ end -}}
  {{- with .sect -}}
    {{- if .IsSection -}}
      {{ safeHTML .Params.head }}
      <li class="dd-item{{if .Params.alwaysopen}} parent{{end}}">
        <a href="{{ .RelPermalink}}"><span>{{safeHTML .Params.Pre}}{{.LinkTitle}}{{safeHTML .Params.Post}}</span>
          {{- if .Params.titleSup -}}
            <sup>{{.Params.titleSup}}</sup>
          {{- end -}}
          {{- $numberOfPages := (add (len .Pages) (len .Sections)) -}}
          {{- if ne $numberOfPages 0 -}}
            {{- if or (.IsAncestor $currentNode) (.Params.alwaysopen) -}}
              <i class="fa fa-sort-down fa-lg category-icon"></i>
            {{- else -}}
              <i class="fa fa-caret-right fa-lg category-icon"></i>
            {{- end -}}
          {{- end -}}
          {{- if $showvisitedlinks -}}
            <i style="color:grey" class="fa fa-circle-thin read-icon"></i>
          {{- end -}}
        </a>
        {{- if ne $numberOfPages 0 -}}
          <ul>
            {{- $currentNode.Scratch.Set "pages" .Pages -}}
            {{- if .Sections -}}
              {{- $currentNode.Scratch.Set "pages" (.Pages | union .Sections) -}}
            {{- end -}}
            {{ $pages := ($currentNode.Scratch.Get "pages") }}
          {{- if eq .Site.Params.ordersectionsby "title" -}}
            {{- range $pages.ByTitle -}}
              {{- if and .Params.hidden (not $.showhidden) -}}
              {{- else -}}
                {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
              {{- end -}}
            {{ end }}
          {{- else -}}
            {{- range $pages.ByWeight -}}
              {{- if and .Params.hidden (not $.showhidden) -}}
              {{- else -}}
                {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}
          </ul>
        {{- end -}}
      </li>
    {{- else -}}
      {{- if not .Params.Hidden -}}
        <li class="dd-item">
          <a href="{{ .RelPermalink}}">
            <span>{{safeHTML .Params.Pre}}{{.LinkTitle}}{{safeHTML .Params.Post}}</span>
          {{- if $showvisitedlinks -}}
            <i style="color:grey" class="fa fa-circle-thin read-icon"></i>
          {{- end -}}
          </a></li>
      {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}